import { gigaChatCompletion, type GigaChatMessage } from '~/server/utils/gigachat'
import { buildPortfolioContext } from '~/server/utils/portfolio-context'

interface ChatMessage {
  role: 'user' | 'assistant' | 'system'
  content: string
}

interface Token {
  symbol: string
  name?: string
  balance: string
  usd: number
  percentage?: string
}

interface Transaction {
  value: string
  direction: 'send' | 'receive'
  status: string
  timestamp: number
  hash?: string
  from?: string
  to?: string
}

interface ChatRequest {
  messages: ChatMessage[]
  context: {
    tokens: Token[]
    totalUsd: number
    transactions?: Transaction[]
    address?: string
    type?: string
  }
}

export default defineEventHandler(async (event) => {
  const body = await readBody<ChatRequest>(event)

  if (!body?.messages?.length) {
    throw createError({ statusCode: 400, statusMessage: 'Missing messages' })
  }

  const config = useRuntimeConfig()
  const tokens = body.context?.tokens || []
  const transactions = body.context?.transactions || []
  const totalUsd = body.context?.totalUsd ?? 0

  // Build compressed portfolio context with market data
  const portfolioContext = await buildPortfolioContext({
    tokens,
    totalUsd,
    transactions,
    address: body.context?.address,
    type: body.context?.type,
  })
  const systemPrompt = `
# –¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –∫—Ä–∏–ø—Ç–æ–ø–æ—Ä—Ç—Ñ–µ–ª–µ–π (GigaChat, Sber)

## –†–æ–ª—å
–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –∫—Ä–∏–ø—Ç–æ–ø–æ—Ä—Ç—Ñ–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–º–æ–≥–∞–µ—à—å:
- –ø–æ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∞–∫—Ç–∏–≤–æ–≤
- –≤—ã—è–≤–∏—Ç—å —Ä–∏—Å–∫–∏ –∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –Ω–∞–π—Ç–∏ —Å–ø–æ—Å–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
- –æ–±—ä—è—Å–Ω–∏—Ç—å –≤—ã–≤–æ–¥—ã –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É

–¢—ã –ù–ï —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –∞ –∞–Ω–∞–ª–∏—Ç–∏–∫.

---

## –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø –æ—Ç–≤–µ—Ç–∞
- **–ö—Ä–∞—Ç–∫–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** (3‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
- –†–∞—Å—à–∏—Ä—è–π –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ—á–µ–≤–∏–¥–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è –≤—ã–≤–æ–¥–∞
- –ù–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞–¥–∏ –∞–Ω–∞–ª–∏–∑–∞

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è
${portfolioContext}
---

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê

### 1Ô∏è‚É£ –ï—Å–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å –ø—É—Å—Ç–æ–π –∏–ª–∏ –ø–æ—á—Ç–∏ –ø—É—Å—Ç–æ–π
(–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å < $5 –ò–õ–ò tokenCount === 0):

- ‚ùå –ù–ï –¥–µ–ª–∞–π –∞–Ω–∞–ª–∏–∑ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚ùå –ù–ï –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
- ‚úÖ –ö—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–∏, —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ (–ø—Ä–∏–º–µ—Ä: –Ω–∞—á–∞—Ç—å —Å BTC / ETH / —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤)

–ü—Ä–∏–º–µ—Ä:
> "–ü–æ—Ä—Ç—Ñ–µ–ª—å –ø–æ–∫–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ö–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –∞–∫—Ç–∏–≤—ã, —è —Å–º–æ–≥—É –æ—Ü–µ–Ω–∏—Ç—å —Ä–∏—Å–∫–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É."

---

### 2Ô∏è‚É£ –§–æ–∫—É—Å –Ω–∞ —Ä–æ—Å—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
–ü—Ä–∏ –ª—é–±–æ–º –∞–Ω–∞–ª–∏–∑–µ –∑–∞–¥–∞–≤–∞–π —Å–µ–±–µ –≤–æ–ø—Ä–æ—Å:
üëâ **—á—Ç–æ –∑–¥–µ—Å—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å?**

–û–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
- —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫—É—é –¥–æ–ª—é –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞
- —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à—É—é –¥–æ–ª—é —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤
- –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ‚Äú—è–∫–æ—Ä–Ω—ã—Ö‚Äù –∞–∫—Ç–∏–≤–æ–≤ (BTC / ETH)
- –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –±–µ–∑ —Ä–æ—Å—Ç–∞

---

### 3Ô∏è‚É£ –°—Ç–µ–π–±–ª–∫–æ–∏–Ω—ã
–ï—Å–ª–∏ –¥–æ–ª—è —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤ > 50%:
- –ø—Ä—è–º–æ —É–∫–∞–∂–∏ –Ω–∞ **–Ω–∏–∑–∫–∏–π –¥–æ—Ö–æ–¥–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª**
- –ù–ï –Ω–∞–∑—ã–≤–∞–π —ç—Ç–æ –æ—à–∏–±–∫–æ–π
- —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫–∞–∫ *—É–ø—É—â–µ–Ω–Ω—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å*

–ü—Ä–∏–º–µ—Ä:
> "–í—ã—Å–æ–∫–∞—è –¥–æ–ª—è —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–æ—Å—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è."

---

### 4Ô∏è‚É£ –ö—Ä—É–ø–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
–ï—Å–ª–∏ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤ > 40% –ø–æ—Ä—Ç—Ñ–µ–ª—è:
- —É–∫–∞–∂–∏ –Ω–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫
- –ø—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∏—Å–∫–∞ (–±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–æ–≤–µ—Ç–æ–≤)

---

### 5Ô∏è‚É£ –¢–æ–Ω –∏ —Å—Ç–∏–ª—å
- –°–ø–æ–∫–æ–π–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
- –ë–µ–∑ —ç–º–æ–¥–∑–∏
- –ë–µ–∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
- –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
- –ò—Å–ø–æ–ª—å–∑—É–π markdown (**–∂–∏—Ä–Ω—ã–π**, —Å–ø–∏—Å–∫–∏), –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ

---

## –ß—Ç–æ —Ç—ã –ú–û–ñ–ï–®–¨ –¥–µ–ª–∞—Ç—å
- –û—Ü–µ–Ω–∏–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Ä—Ç—Ñ–µ–ª—è
- –ù–∞—Ö–æ–¥–∏—Ç—å –¥–∏—Å–±–∞–ª–∞–Ω—Å—ã
- –ü–æ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω–∏—è
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
- –û–±—ä—è—Å–Ω—è—Ç—å, *–ø–æ—á–µ–º—É* –ø–æ—Ä—Ç—Ñ–µ–ª—å –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫

## –ß–µ–≥–æ —Ç—ã –ù–ï –¥–µ–ª–∞–µ—à—å
- –ù–µ –¥–∞—ë—à—å –ø—Ä—è–º—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤
- –ù–µ –≥–æ–≤–æ—Ä–∏—à—å ¬´–ø–æ–∫—É–ø–∞–π / –ø—Ä–æ–¥–∞–≤–∞–π¬ª
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–µ—à—å –¥–∞–Ω–Ω—ã–µ
- –ù–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

---

## –¶–µ–ª—å –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
–ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω:
- –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–≤–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å
- —É–≤–∏–¥–µ—Ç—å 1‚Äì2 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
- –Ω–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
\`;`

  const messages: GigaChatMessage[] = [
    { role: 'system', content: systemPrompt },
    ...body.messages,
  ]

  try {
    const model = config.gigaChatModel || 'GigaChat-2'
    const content = await gigaChatCompletion(messages, model)

    return { message: content }
  } catch (err: any) {
    const detail = err?.message || err?.toString?.() || 'Unknown error'
    throw createError({
      statusCode: 502,
      statusMessage: `GigaChat error: ${detail}`,
    })
  }
})
